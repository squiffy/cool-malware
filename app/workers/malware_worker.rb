require 'digest'

class MalwareWorker
  include Sidekiq::Worker

  def perform file_path, malware_id
  
    malware = Malware.find malware_id

    # Lets first get a digest of the file
    digest = Digest::SHA2.hexdigest File.read file_path

    malware.file_hash = digest
    malware.save

    # make object inside the bucket for the upload
    s3 = Aws::S3::Resource.new region: 'us-east-1'

    obj = s3.bucket('cool-malware').object digest

    # Lets see if the resource exists before we upload
    if not obj.exists?
      obj.upload_file file_path, acl: 'public-read'
    end

    malware.s3_url = obj.public_url.to_s
    malware.save

  end
end
