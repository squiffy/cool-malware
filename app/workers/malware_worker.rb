require 'digest'
require 'virustotal_api'

class MalwareWorker
  include Sidekiq::Worker

  def perform file_path, malware_id

    malware = Malware.find malware_id

    # Lets first get a digest of the file
    digest = Digest::SHA256.hexdigest File.read file_path

    malware.file_hash = digest
    malware.save

    threads = []
    threads << Thread.new do
      s3_upload file_path, malware_id
    end

    threads << Thread.new do
      while virustotal_upload file_path, malware_id
        puts "trying again"
        sleep 1.minute
      end
    end

    threads.each do |t|
      t.join
    end

  end

  def s3_upload file_path, malware_id
    
    malware = Malware.find malware_id

    # make object inside the bucket for the upload
    s3 = Aws::S3::Resource.new region: 'us-east-1'

    obj = s3.bucket('cool-malware').object malware.file_hash

    # Lets see if the resource exists before we upload
    if not obj.exists?
      obj.upload_file file_path, acl: 'public-read'
    end

    malware.s3_url = obj.public_url.to_s
    malware.save
  end

  def virustotal_upload file_path, malware_id

    malware = Malware.find malware_id
    again = false

    # Let's see if VT already has the signature
    vtreport = VirustotalAPI::FileReport.find malware.file_hash, VIRUSTOTAL_API_KEY
    if vtreport.report['response_code'] == 1
      puts "we found it!"
      malware.virustotal_av_positives = vtreport.report['positives']
      malware.virustotal_av_total = vtreport.report['total']
      malware.virustotal_url = vtreport.report_url
    elsif vtreport.response['response_code'] == -2
      puts "already queued"
      again = true
    else
      # No match found; we gotta upload this one
      VirustotalAPI::FileScan.scan file_path, VIRUSTOTAL_API_KEY
      again = true
    end

    malware.save
    return again

  end

end

