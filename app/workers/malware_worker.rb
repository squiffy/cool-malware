require 'digest'
require 'virustotal_api'

class MalwareWorker
  include Sidekiq::Worker

  def perform file_path, malware_id
    threads = []
    threads << Thread.new do
     # s3_upload file_path, malware_id
    end

    threads << Thread.new do
      virustotal_upload file_path, malware_id
    end

    threads.each do |t|
      t.join
    end

  end

  def s3_upload file_path, malware_id
    malware = Malware.find malware_id

    # Lets first get a digest of the file
    digest = Digest::SHA1.hexdigest File.read file_path

    malware.file_hash = digest
    malware.save

    # make object inside the bucket for the upload
    s3 = Aws::S3::Resource.new region: 'us-east-1'

    obj = s3.bucket('cool-malware').object digest

    # Lets see if the resource exists before we upload
    if not obj.exists?
      obj.upload_file file_path, acl: 'public-read'
    end

    malware.s3_url = obj.public_url.to_s
    malware.save
  end

  def virustotal_upload file_path, malware_id

    puts VIRUSTOTAL_API_KEY
  
    malware = Malware.find malware_id
    vtscan = VirustotalAPI::FileScan.scan file_path, VIRUSTOTAL_API_KEY
    puts vtscan.response

    malware.virustotal_url = vtscan.response['permalink']
    malware.save

  end

end

